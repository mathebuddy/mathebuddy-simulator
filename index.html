<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>mathe:buddy SIMULATOR</title>

    <script src="node_modules/axios/dist/axios.min.js"></script>
    <script src="node_modules/lz-string/libs/lz-string.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <link
      rel="stylesheet"
      href="node_modules/bootstrap/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="node_modules/@fortawesome/fontawesome-free/css/all.min.css"
    />

    <!-- TODO: ensure that latest(!!) version is loaded! -->
    <script src="build/mathebuddy-simulator.min.js"></script>

    <style>
      body {
        background-color: rgb(255, 255, 255);
      }
    </style>
  </head>

  <body>
    <div class="container text-start">
      <br />

      <!-- TOOLBAR: FILE LIST, BUTTONS, LOG SELECTION -->
      <div class="row text-start">
        <div class="col">
          <img src="img/logo-large-en.svg" style="width: 256px" />

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

          <button
            type="button"
            onclick="selectFile(selectedFileIndex);"
            class="btn btn-sm btn-success"
            data-bs-toggle="tooltip"
            data-bs-placement="top"
            title="simulate file"
          >
            <i class="fa-solid fa-person-running"></i>
          </button>

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

          <span id="selected-file-id" class="text-primary"
            >SELECT A FILE <i class="fa-solid fa-arrow-right-long"></i
          ></span>
          <span class="text-primary"><i class="fas fa-layer-group"></i></span>
          <div
            class="dropdown"
            style="display: inline-block"
            data-bs-toggle="tooltip"
            data-bs-placement="left"
            title="course selection"
          >
            <button
              class="btn btn-sm btn-primary dropdown-toggle"
              type="button"
              id="courselist_button"
              data-bs-toggle="dropdown"
              onclick=""
            ></button>
            <ul id="courselist_dropdown_items" class="dropdown-menu">
              <li><a class="dropdown-item" style="cursor: pointer">hm1</a></li>
              <li><a class="dropdown-item" style="cursor: pointer">hm2</a></li>
            </ul>
          </div>

          <button
            type="button"
            onclick="refreshFileList();"
            class="btn btn-sm btn-primary"
            data-bs-toggle="tooltip"
            data-bs-placement="top"
            title="refresh file list"
          >
            <i class="fa-solid fa-arrows-rotate"></i>
          </button>

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

          <div class="form-check form-check-inline">
            <input
              class="form-check-input"
              type="radio"
              name="inlineRadioOptions"
              id="radio-JSON"
              value="option1"
              onclick="logInput();"
              checked
            />
            <label class="form-check-label" for="radio-JSON">input</label>
          </div>
          <div class="form-check form-check-inline">
            <input
              class="form-check-input"
              type="radio"
              name="inlineRadioOptions"
              id="radio-JSON"
              value="option2"
              onclick="logJson();"
            />
            <label class="form-check-label" for="radio-JSON">JSON</label>
          </div>
          <div class="form-check form-check-inline">
            <input
              class="form-check-input"
              type="radio"
              name="inlineRadioOptions"
              id="radio-HTML"
              value="option3"
              onclick="logHtml();"
            />
            <label class="form-check-label" for="radio-HTML">HTML</label>
          </div>

          &nbsp;&nbsp;&nbsp;&nbsp; <i>mathe:buddy SIMULATOR</i>
        </div>
      </div>
    </div>

    <br />

    <div class="container">
      <!-- DEVICE AND LOG AREA -->
      <div class="row text-start">
        <div
          id="device"
          class="col shadow m-0 p-0 bg-white"
          style="
            width: 320px;
            min-width: 320px;
            max-width: 320px;
            height: 640px;
            min-height: 640px;
            max-height: 640px;
          "
        >
          <img src="img/app-bg.png" class="p-0" style="width: 100%" />
          <div
            id="device-content"
            class="py-0 px-2"
            style="
              height: 500px;
              overflow-x: hidden;
              overflow-y: scroll;
              font-size: 85%;
              transform: translate(0, -5px);
            "
          ></div>
        </div>
        <div
          id="log"
          class="col bg-dark mx-3 small"
          style="max-height: 640px; overflow: scroll"
        >
          <div id="log-content" class="p-2"></div>
        </div>
      </div>
    </div>

    <script>
      var deviceContent = document.getElementById('device-content');
      var logContent = document.getElementById('log-content');
      var input = ''; // MBL data
      var sim = null;

      var files = [];
      var selectedFileIndex = -1;

      function logInput() {
        if (sim == null) return;
        let i = input.replace(/</g, '&lt;');
        i = i.replace(/>/g, '&gt;');
        i = i.replace(/\n/g, '<br/>');
        i = i.replace(/ /g, '&nbsp;');
        i = i.replace(/"/g, '&quot;');
        i = i.replace(/'/g, '&#039;');
        logContent.innerHTML = '<div class="text-white">' + i + '</div>';
      }

      function logJson() {
        if (sim == null) return;
        logContent.innerHTML =
          '<div class="text-white">' + mathebuddySIM.getJSON(sim) + '</div>';
      }

      function logHtml() {
        if (sim == null) return;
        logContent.innerHTML =
          '<div class="text-white">' + mathebuddySIM.getHTML(sim) + '</div>';
      }

      function refreshFileList() {
        axios
          .get('__FILES__', {
            responseType: 'text',
          })
          .then(function (response) {
            //console.log(response.data);
            files = response.data.split('##');
            //console.log(files);
            const dropdown = document.getElementById(
              'courselist_dropdown_items',
            );
            let html = '';
            let i = 0;
            for (const file of files) {
              let onclick = 'selectFile(' + i + ');';
              html +=
                '<li><a onclick="' +
                onclick +
                '" class="dropdown-item" style="cursor: pointer">' +
                file.replace('../mathebuddy-public-courses/', '') +
                '</a></li>';
              i++;
            }
            dropdown.innerHTML = html;
          });
      }

      refreshFileList();

      const filePath =
        'testdata/mathebuddy-public-courses/demo-basic/hello.mbl';
      const filePathCompiled =
        filePath.substring(0, filePath.length - 4) + '_COMPILED.hex';

      function selectFile(index) {
        selectedFileIndex = index;
        const path = files[index];

        document.getElementById('selected-file-id').innerHTML = path.replace(
          '../mathebuddy-public-courses/',
          '',
        );

        //console.log('LOADING FILE ' + path);

        axios.get(path, { responseType: 'text' }).then(function (response) {
          //console.log('LOADED:');
          //console.log(response.data);
          input = response.data;
          const course = mathebuddySIM.compile(input);
          //console.log(course);
          sim = mathebuddySIM.createSim(course, deviceContent);
          if (mathebuddySIM.generateDOM(sim) == false) {
            console.log("ERROR: there is no document 'intro'");
          }
          logInput();
        });

        return; // TODO

        // get input data
        axios
          .get(filePath, {
            responseType: 'text',
          })
          .then(function (response) {
            input = response.data;
            input = input.replace(/</g, '&lt;');
            input = input.replace(/>/g, '&gt;');
            input = input.replace(/\n/g, '<br/>');
            input = input.replace(/ /g, '&nbsp;');
            input = input.replace(/"/g, '&quot;');
            input = input.replace(/'/g, '&#039;');
          });
        // get compiled course
        axios
          //.get('testdata/chapter1.txt_COMPILED_COMPRESSED.hex', {
          .get(filePathCompiled, {
            responseType: 'arraybuffer',
          })
          .then(function (response) {
            //console.log(response.data);
            var documentData = btoa(
              String.fromCharCode.apply(null, new Uint8Array(response.data)),
            );
            documentData = LZString.decompressFromBase64(documentData);
            documentData = JSON.parse(documentData);
            //console.log(documentData);
            sim = mathebuddySIM.createSim(documentData, deviceContent);
            if (mathebuddySIM.generateDOM(sim) == false) {
              console.log("ERROR: there is no document 'intro'");
            }
            //logJson();
            logInput();
          });
      }

      //refresh();
    </script>
  </body>
</html>
