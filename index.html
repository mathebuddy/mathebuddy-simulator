<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>mathe:buddy SIMULATOR</title>

    <script src="node_modules/axios/dist/axios.min.js"></script>
    <script src="node_modules/lz-string/libs/lz-string.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <link
      rel="stylesheet"
      href="node_modules/bootstrap/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="node_modules/@fortawesome/fontawesome-free/css/all.min.css"
    />

    <!-- TODO: ensure that latest(!!) version is loaded! -->
    <script src="build/mathebuddy-simulator.min.js"></script>

    <style>
      body {
        background-color: rgb(255, 255, 255);
      }
    </style>
  </head>

  <body>
    <div class="container text-start">
      <br />

      <!-- TOOLBAR: FILE LIST, BUTTONS, LOG SELECTION -->
      <div class="row text-start">
        <div class="col">
          <img src="img/logo-large-en.svg" style="width: 256px" />

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

          <button
            type="button"
            onclick="refreshFileList();"
            class="btn btn-sm btn-success"
            data-bs-toggle="tooltip"
            data-bs-placement="top"
            title="refresh file tree"
          >
            <i class="fa-solid fa-arrows-rotate"></i>
          </button>

          <button
            type="button"
            onclick="run();"
            class="btn btn-sm btn-success"
            data-bs-toggle="tooltip"
            data-bs-placement="top"
            title="simulate file"
          >
            <i class="fa-solid fa-person-running"></i>
          </button>

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

          <span class="text-primary"><i class="fas fa-layer-group"></i></span>

          <span id="file-menu"></span>

          <!--
          <div
            class="dropdown"
            style="display: inline-block"
            data-bs-toggle="tooltip"
            data-bs-placement="left"
            title="course selection"
          >
            <button
              class="btn btn-sm btn-primary dropdown-toggle"
              type="button"
              id="courselist_button"
              data-bs-toggle="dropdown"
              onclick=""
            ></button>
            <ul id="courselist_dropdown_items" class="dropdown-menu">
              <li><a class="dropdown-item" style="cursor: pointer">hm1</a></li>
              <li><a class="dropdown-item" style="cursor: pointer">hm2</a></li>
            </ul>
          </div>
          <span id="selected-file-id" class="text-primary"></span>
          -->

          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

          <div class="form-check form-check-inline">
            <input
              class="form-check-input"
              type="radio"
              name="inlineRadioOptions"
              id="radio-JSON"
              value="option1"
              onclick="logInput();"
              checked
            />
            <label class="form-check-label" for="radio-JSON">input</label>
          </div>
          <div class="form-check form-check-inline">
            <input
              class="form-check-input"
              type="radio"
              name="inlineRadioOptions"
              id="radio-JSON"
              value="option2"
              onclick="logJson();"
            />
            <label class="form-check-label" for="radio-JSON">JSON</label>
          </div>
          <div class="form-check form-check-inline">
            <input
              class="form-check-input"
              type="radio"
              name="inlineRadioOptions"
              id="radio-HTML"
              value="option3"
              onclick="logHtml();"
            />
            <label class="form-check-label" for="radio-HTML">HTML</label>
          </div>

          <!--&nbsp;&nbsp;&nbsp;&nbsp; <i>mathe:buddy SIMULATOR</i>-->
        </div>
      </div>
    </div>

    <br />

    <div class="container">
      <!-- DEVICE AND LOG AREA -->
      <div class="row text-start">
        <div
          id="device"
          class="col shadow m-0 p-0 bg-white"
          style="
            width: 320px;
            min-width: 320px;
            max-width: 320px;
            height: 640px;
            min-height: 640px;
            max-height: 640px;
          "
        >
          <img src="img/app-bg.png" class="p-0" style="width: 100%" />
          <div
            id="device-content"
            class="py-0 px-2"
            style="
              height: 500px;
              overflow-x: hidden;
              overflow-y: scroll;
              font-size: 85%;
              transform: translate(0, -5px);
            "
          ></div>
        </div>
        <div
          id="log"
          class="col bg-dark mx-3 small"
          style="max-height: 640px; overflow: scroll"
        >
          <div id="log-content" class="p-2"></div>
        </div>
      </div>
    </div>

    <script>
      var deviceContent = document.getElementById('device-content');
      var logContent = document.getElementById('log-content');
      var input = ''; // MBL data
      var sim = null;

      var files = [];
      var selectedFileIndex = -1;

      function logInput() {
        if (sim == null) return;
        let i = input.replace(/</g, '&lt;');
        i = i.replace(/>/g, '&gt;');
        i = i.replace(/\n/g, '<br/>');
        i = i.replace(/ /g, '&nbsp;');
        i = i.replace(/"/g, '&quot;');
        i = i.replace(/'/g, '&#039;');
        logContent.innerHTML = '<div class="text-white">' + i + '</div>';
      }

      function logJson() {
        if (sim == null) return;
        logContent.innerHTML =
          '<div class="text-white">' + mathebuddySIM.getJSON(sim) + '</div>';
      }

      function logHtml() {
        if (sim == null) return;
        logContent.innerHTML =
          '<div class="text-white">' + mathebuddySIM.getHTML(sim) + '</div>';
      }

      var selectedPath = [];
      var dropdownElements = [];

      function appendFileDropdown(data, depth) {
        const dropdown = document.createElement('div');
        dropdownElements[depth] = dropdown;
        document.getElementById('file-menu').appendChild(dropdown);
        dropdown.classList.add('dropdown');
        dropdown.style.display = 'inline-block';
        dropdown.setAttribute('data-bs-toggle', 'tooltip');
        dropdown.setAttribute('data-bs-placement', 'left');
        dropdown.title = 'course selection';
        const button = document.createElement('button');
        dropdown.appendChild(button);
        button.classList.add('btn', 'btn-sm', 'btn-primary', 'dropdown-toggle');
        button.type = 'button';
        button.setAttribute('data-bs-toggle', 'dropdown');
        const ul = document.createElement('ul');
        dropdown.appendChild(ul);
        ul.classList.add('dropdown-menu');
        const fileId = document.createElement('span');
        dropdown.appendChild(fileId);
        fileId.classList.add('text-primary');
        fileId.innerHTML = '&nbsp;(nothing selected)&nbsp;';
        const dataSortedKeys = Object.keys(data).sort();
        for (const file of dataSortedKeys) {
          const isDirectory = Object.keys(data[file]).length > 0;
          const li = document.createElement('li');
          ul.appendChild(li);
          const a = document.createElement('a');
          li.append(a);
          a.classList.add('dropdown-item');
          a.style.cursor = 'pointer';
          a.innerHTML = '' + file + (isDirectory ? '/' : '');
          a.onclick = function (event) {
            fileId.innerHTML =
              '&nbsp;' +
              file
                .replace('../mathebuddy-public-courses', 'PUBLIC')
                .replace('../mathebuddy-private-courses', 'PRIVATE') +
              (isDirectory ? '/' : '') +
              '&nbsp;';
            selectedPath[depth] = file;
            selectedPath.length = depth + 1;
            //console.log(selectedPath);
            for (let i = depth + 1; i < dropdownElements.length; i++) {
              document
                .getElementById('file-menu')
                .removeChild(dropdownElements[i]);
            }
            dropdownElements.length = depth + 1;
            if (isDirectory) {
              appendFileDropdown(data[file], depth + 1);
            }
          };
        }
      }

      function refreshFileList() {
        axios.get('__FILES__').then(function (response) {
          appendFileDropdown(response.data, 0);
        });
      }

      refreshFileList();

      const filePath =
        'testdata/mathebuddy-public-courses/demo-basic/hello.mbl';
      const filePathCompiled =
        filePath.substring(0, filePath.length - 4) + '_COMPILED.hex';

      function run() {
        const path = selectedPath.join('/');
        if (path.endsWith('.mbl') == false) {
          console.log('error: path "' + path + '" is invalid for running!');
          return;
        }
        console.log('running file ' + path);

        // TODO
      }

      // TODO: THE FOLLOWING CODE IS OLD!!

      function selectFile(index) {
        selectedFileIndex = index;
        const path = files[index];

        document.getElementById('selected-file-id').innerHTML = path
          .replace('../mathebuddy-public-courses/', 'PUBLIC/')
          .replace('../mathebuddy-private-courses/', 'PRIVATE/');

        //console.log('LOADING FILE ' + path);

        axios.get(path, { responseType: 'text' }).then(function (response) {
          //console.log('LOADED:');
          //console.log(response.data);
          input = response.data;
          const course = mathebuddySIM.compile(input);
          //console.log(course);
          sim = mathebuddySIM.createSim(course, deviceContent);
          if (mathebuddySIM.generateDOM(sim) == false) {
            console.log("ERROR: there is no document 'intro'");
          }
          logInput();
        });

        return; // TODO

        // get input data
        axios
          .get(filePath, {
            responseType: 'text',
          })
          .then(function (response) {
            input = response.data;
            input = input.replace(/</g, '&lt;');
            input = input.replace(/>/g, '&gt;');
            input = input.replace(/\n/g, '<br/>');
            input = input.replace(/ /g, '&nbsp;');
            input = input.replace(/"/g, '&quot;');
            input = input.replace(/'/g, '&#039;');
          });
        // get compiled course
        axios
          //.get('testdata/chapter1.txt_COMPILED_COMPRESSED.hex', {
          .get(filePathCompiled, {
            responseType: 'arraybuffer',
          })
          .then(function (response) {
            //console.log(response.data);
            var documentData = btoa(
              String.fromCharCode.apply(null, new Uint8Array(response.data)),
            );
            documentData = LZString.decompressFromBase64(documentData);
            documentData = JSON.parse(documentData);
            //console.log(documentData);
            sim = mathebuddySIM.createSim(documentData, deviceContent);
            if (mathebuddySIM.generateDOM(sim) == false) {
              console.log("ERROR: there is no document 'intro'");
            }
            //logJson();
            logInput();
          });
      }

      //refresh();
    </script>
  </body>
</html>
